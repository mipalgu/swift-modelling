name: Homebrew Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v0.1.0)'
        required: true

jobs:
  build-bottles:
    name: Build Bottles
    uses: ./.github/workflows/build-bottles.yml
    with:
      tag: ${{ github.event.inputs.tag || github.ref_name }}
    secrets: inherit

  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [build-bottles]
    steps:
      - name: Checkout swift-modelling
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate checksums and update formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag || github.ref_name }}
        run: |
          # Strip 'v' prefix for version (v0.1.0 -> 0.1.0)
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION"

          # Download source tarball and calculate SHA256
          wget -q "https://github.com/mipalgu/swift-modelling/archive/refs/tags/${TAG}.tar.gz" -O source.tar.gz
          SOURCE_SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)
          echo "SOURCE_SHA256=$SOURCE_SHA256"

          # Download bottles from release
          mkdir -p bottles
          gh release download "${TAG}" --repo mipalgu/swift-modelling --pattern "swift-modelling-*.bottle.tar.gz" -D bottles/ || true

          # Calculate bottle checksums
          MACOS_ARM64_SHA256=""
          LINUX_X86_64_SHA256=""

          if [ -f "bottles/swift-modelling-${VERSION}.arm64_sequoia.bottle.tar.gz" ]; then
            MACOS_ARM64_SHA256=$(sha256sum "bottles/swift-modelling-${VERSION}.arm64_sequoia.bottle.tar.gz" | cut -d' ' -f1)
            echo "MACOS_ARM64_SHA256=$MACOS_ARM64_SHA256"
          fi

          if [ -f "bottles/swift-modelling-${VERSION}.x86_64_linux.bottle.tar.gz" ]; then
            LINUX_X86_64_SHA256=$(sha256sum "bottles/swift-modelling-${VERSION}.x86_64_linux.bottle.tar.gz" | cut -d' ' -f1)
            echo "LINUX_X86_64_SHA256=$LINUX_X86_64_SHA256"
          fi

          # Clone homebrew-tap
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/mipalgu/homebrew-tap.git homebrew-tap
          cd homebrew-tap

          # Generate the formula using echo commands
          echo 'class SwiftModelling < Formula' > Formula/swift-modelling.rb
          echo '  desc "A CLI wrapper for the Swift Modelling Framework (EMF, ATL, MTL)"' >> Formula/swift-modelling.rb
          echo '  homepage "https://github.com/mipalgu/swift-modelling"' >> Formula/swift-modelling.rb
          echo "  url \"https://github.com/mipalgu/swift-modelling/archive/refs/tags/${TAG}.tar.gz\"" >> Formula/swift-modelling.rb
          echo "  sha256 \"${SOURCE_SHA256}\"" >> Formula/swift-modelling.rb
          echo '  license "MIT"' >> Formula/swift-modelling.rb
          echo '  env :std' >> Formula/swift-modelling.rb
          echo '  head "https://github.com/mipalgu/swift-modelling.git", branch: "main"' >> Formula/swift-modelling.rb
          echo '' >> Formula/swift-modelling.rb

          # Add bottle block if we have bottles
          if [ -n "$MACOS_ARM64_SHA256" ] || [ -n "$LINUX_X86_64_SHA256" ]; then
            echo '  bottle do' >> Formula/swift-modelling.rb
            echo "    root_url \"https://github.com/mipalgu/swift-modelling/releases/download/${TAG}\"" >> Formula/swift-modelling.rb
            if [ -n "$MACOS_ARM64_SHA256" ]; then
              echo "    sha256 cellar: :any_skip_relocation, arm64_sequoia: \"${MACOS_ARM64_SHA256}\"" >> Formula/swift-modelling.rb
            fi
            if [ -n "$LINUX_X86_64_SHA256" ]; then
              echo "    sha256 cellar: :any_skip_relocation, x86_64_linux: \"${LINUX_X86_64_SHA256}\"" >> Formula/swift-modelling.rb
            fi
            echo '  end' >> Formula/swift-modelling.rb
            echo '' >> Formula/swift-modelling.rb
          fi

          echo '  on_macos do' >> Formula/swift-modelling.rb
          echo '    depends_on :xcode => ["26.0", :build]' >> Formula/swift-modelling.rb
          echo '  end' >> Formula/swift-modelling.rb
          echo '' >> Formula/swift-modelling.rb
          echo '  on_linux do' >> Formula/swift-modelling.rb
          echo '    # Check the original PATH before Homebrew scrubbed it' >> Formula/swift-modelling.rb
          echo '    original_path = ENV["HOMEBREW_PATH"] || ENV["PATH"]' >> Formula/swift-modelling.rb
          echo '    swift_found = original_path.split(File::PATH_SEPARATOR).any? do |dir|' >> Formula/swift-modelling.rb
          echo '      File.exist?(File.join(dir, "swift"))' >> Formula/swift-modelling.rb
          echo '    end' >> Formula/swift-modelling.rb
          echo '    depends_on "swift" => :build unless swift_found' >> Formula/swift-modelling.rb
          echo '  end' >> Formula/swift-modelling.rb
          echo '' >> Formula/swift-modelling.rb
          echo '  def install' >> Formula/swift-modelling.rb
          echo '    # If swiftly is in the PATH, ensure its environment variables are set' >> Formula/swift-modelling.rb
          echo '    # because Homebrew might have scrubbed them even if it kept the PATH.' >> Formula/swift-modelling.rb
          echo '    original_path = ENV["HOMEBREW_PATH"] || ENV["PATH"]' >> Formula/swift-modelling.rb
          echo '    swift_dir = original_path.split(File::PATH_SEPARATOR).find do |dir|' >> Formula/swift-modelling.rb
          echo '      File.exist?(File.join(dir, "swift"))' >> Formula/swift-modelling.rb
          echo '    end' >> Formula/swift-modelling.rb
          echo '' >> Formula/swift-modelling.rb
          echo '    if swift_dir && swift_dir.include?("swiftly")' >> Formula/swift-modelling.rb
          echo '      ENV["SWIFTLY_BIN_DIR"] = swift_dir' >> Formula/swift-modelling.rb
          echo '      ENV["SWIFTLY_HOME_DIR"] = File.dirname(swift_dir)' >> Formula/swift-modelling.rb
          echo '    end' >> Formula/swift-modelling.rb
          echo '' >> Formula/swift-modelling.rb
          echo '    system "swift", "build", "--disable-sandbox", "-c", "release"' >> Formula/swift-modelling.rb
          echo '    bin.install ".build/release/swift-ecore"' >> Formula/swift-modelling.rb
          echo '    bin.install ".build/release/swift-atl"' >> Formula/swift-modelling.rb
          echo '    bin.install ".build/release/swift-mtl"' >> Formula/swift-modelling.rb
          echo '  end' >> Formula/swift-modelling.rb
          echo '' >> Formula/swift-modelling.rb
          echo '  test do' >> Formula/swift-modelling.rb
          echo '    system "#{bin}/swift-ecore", "--help"' >> Formula/swift-modelling.rb
          echo '    system "#{bin}/swift-atl", "--help"' >> Formula/swift-modelling.rb
          echo '    system "#{bin}/swift-mtl", "--help"' >> Formula/swift-modelling.rb
          echo '  end' >> Formula/swift-modelling.rb
          echo 'end' >> Formula/swift-modelling.rb

          echo "Generated formula:"
          cat Formula/swift-modelling.rb

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git checkout -b "update-swift-modelling-${TAG}"
          git add Formula/swift-modelling.rb
          git commit -m "Update swift-modelling to ${TAG}" -m "Release includes pre-built bottles for macOS and Linux"
          git push origin "update-swift-modelling-${TAG}"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag || github.ref_name }}
        run: |
          cd homebrew-tap
          gh pr create --title "Update swift-modelling to ${TAG}" \
            --body "Automated update of swift-modelling formula for release ${TAG}

          Includes pre-built bottles for:
          - macOS ARM64 (Sequoia)
          - Linux x86_64" \
            --base master \
            --head "update-swift-modelling-${TAG}" \
            --repo mipalgu/homebrew-tap
